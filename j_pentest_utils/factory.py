#!/usr/bin/env python2
# encoding: utf8

import os
import sys
import time
import json
import argparse
import traceback
from abc import ABCMeta, abstractmethod

import Queue
import gevent
from gevent import monkey
monkey.patch_all()

class BaseFactory( object ):
    __metaclass__ = ABCMeta

    def __init__(self, args):
        self.args = args
        self.job_queue = Queue.Queue( 1024*8 )
        self.success_queue = Queue.Queue( 1024 )
        gevent.spawn( self.manager )
        gevent.spawn( self.success_log )
        for worker_index in xrange( self.args.thread ):
            gevent.spawn( self.worker )

    @abstractmethod
    def do_job(self, job):
        pass

    @abstractmethod
    def manager(self):
        pass

    def success_log(self):
        success_txt_fout = open( 'success.txt', 'ab' )
        while True:
            s = self.success_queue.get()
            print s
            success_txt_fout.write( json.dumps( s ) + '\n' )
            success_txt_fout.flush()

    def worker(self):
        while True:
            job = self.job_queue.get()
            try:
                t = gevent.spawn( self.do_job, job )
                t.join( job['timeout'] )
            except Exception as e:
                print e.args
                sys.exc_clear()
